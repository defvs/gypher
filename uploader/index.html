<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Gif upload form</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Shadows+Into+Light&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Baloo+Thambi+2:wght@500&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.perfect-scrollbar/1.5.0/perfect-scrollbar.js"></script>
	<link rel="stylesheet"
		  href="https://cdnjs.cloudflare.com/ajax/libs/jquery.perfect-scrollbar/1.5.0/css/perfect-scrollbar.css">
	<link href="style.css" rel="stylesheet"/>
</head>
<body>
<div id="videoDiv">
	<video autoplay muted loop id="video0">
		<source src="" type="video/mp4">
	</video>
	<video autoplay muted loop id="video1">
		<source src="" type="video/mp4">
	</video>
</div>
<div class="content">
	<p>Submitted by: <span id="author"></span></p>
</div>
<!--<img class="logo" src="logo.png" alt="Logo">-->
<div class="centered">
	<div class="back">
		<h1>Submit an animated background</h1>
		<form class="form">
			<label for="username"></label><input class="size2" type="text" id="username" name="username"
												 placeholder="Username"><br>
			<label for="gif-search"></label><input required class="size3" type="text" id="gif-search" name="url"
												   placeholder="Search for a gif..." autocomplete="off"><br>
			<div id="gif-results" hidden></div>
			<input class="submit" type="submit" value="Add">
		</form>
	</div>
</div>
<script src="videoLoad.js"></script>
<script src="submitForm.js"></script>
<script>
	var selectedGif = null;
	
	let typingTimer;
	const doneTypingInterval = 500;
	
	let gifResults = $('#gif-results');
	
	let field = $('#gif-search').on("keyup", function () {
		clearTimeout(typingTimer);
		selectedGif = null;
		redField(true);
		if ($(this).val()) {
			typingTimer = setTimeout(doneTyping, doneTypingInterval);
			gifResults.empty();
			for (i = 0; i < 10; i++) gifResults.append("<div class='gif-result' style='width: 150px;'></div>");
			gifResults.removeAttr("hidden");
		} else {
			gifResults.attr("hidden", "");
		}
	});
	
	let currentSubmitState = true;
	function redField(red, duration = 500) {
		const submitButton = $(".submit");
		if (red === true && currentSubmitState === true) {
			submitButton.animate({backgroundColor: "rgba(255,22,39,0.3)", color: "rgba(255, 255, 255, 0.0)"}, duration, function () {
				submitButton.attr("value", "Select a GIF...").animate({color: "rgba(255, 255, 255, 1)"}, duration);
			});
			currentSubmitState = false;
		} else if (red === false && currentSubmitState === false) {
			submitButton.animate({backgroundColor: "rgba(0, 0, 0, 0.3)", color: "rgba(255, 255, 255, 0.0)"}, duration, function () {
				submitButton.attr("value", "Submit").animate({color: "rgba(255, 255, 255, 1)"}, duration);
			});
			currentSubmitState = true;
		}
	}
	
	redField(true, 0);
	
	function doneTyping() {
		let request;
		if (field.val().startsWith("https://giphy.com/gifs/"))
			request = $.get(`https://api.giphy.com/v1/gifs/${field.val().substring(field.val().lastIndexOf('-') + 1)}?api_key=z6T7uPAQUd96dUuoEEAV3B8etfOZOc5n`, null, "json");
		else if (field.val() === "random")
			request = $.get(`https://api.giphy.com/v1/gifs/random?api_key=z6T7uPAQUd96dUuoEEAV3B8etfOZOc5n`, null, "json");
		else
			request = $.get(`https://api.giphy.com/v1/gifs/search?api_key=z6T7uPAQUd96dUuoEEAV3B8etfOZOc5n&q=${field.val()}&limit=10&offset=0&rating=G&lang=en`, null, "json");
		request.done(function (obj) {
			if (obj.data.length === 0) {
				return;
			}
			gifResults.empty();
			const ps = new PerfectScrollbar('#gif-results');
			
			let data;
			if (!Array.isArray(obj.data)) data = [obj.data];
			else data = obj.data;
			
			data.forEach(function (gif) {
				let str = `<div class='gif-result' style='width: ${gif.images.fixed_height_small.width}px'><video autoplay muted loop><source src='${gif.images.fixed_height_small.mp4}' type=video/mp4></video></div>`;
				gifResults.append(str);
				ps.update();
			});
			let allResults = gifResults.children();
			allResults.each(function () {
				$(this).children("video").on("click", function () {
					$("#tick-icon").remove();
					$(".shadowed").css("filter", "").removeClass("shadowed");
					$(this).css("filter", "contrast(30%)").addClass("shadowed").parent().append("<img id='tick-icon' src=\"check.svg\" alt=\"selected\" height='64px' width='64px'>");
					selectedGif = data[$(this).parent().index()];
					redField(false);
					return false;
				})
			})
		});
	}
</script>
</body>
</html>